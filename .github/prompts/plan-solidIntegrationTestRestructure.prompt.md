# Plan: Component-Style Integration Test Restructure

Start from scratch with a Playwright-inspired Page Component architecture for Patrol E2E tests. Each screen gets a component class that encapsulates its finders, actions, and assertions. Tests compose components together like building blocks. Existing tests are moved to `bak/` as reference only — no code is reused.

## Architecture

```
integration_test/
├── components/           # Reusable screen components (Page Objects)
│   ├── app.dart          # App lifecycle (launch, reset)
│   ├── welcome.dart      # WelcomeScreen component
│   ├── login.dart        # LoginScreen component
│   ├── home.dart         # HomeScreen component
│   ├── history.dart      # HistoryScreen component
│   ├── analytics.dart    # AnalyticsScreen component
│   ├── logging.dart      # LoggingScreen component
│   ├── accounts.dart     # AccountsScreen component
│   └── nav_bar.dart      # Bottom navigation bar component
├── helpers/
│   ├── pump.dart         # pumpUntilFound, pumpUntilGone
│   └── config.dart       # PatrolTesterConfig, NativeAutomatorConfig, credentials
├── flows/                # Multi-step composed flows (chains of component actions)
│   └── login_flow.dart   # launchAndLogin — combines App + Welcome + Login + Home
├── login_flow_test.dart  # ✅ Confirmed working — rebuild to use components
├── test_bundle.dart      # Auto-generated by patrol
└── bak/                  # Old tests for reference only
```

### Component Pattern

Every component follows the same shape — inspired by Playwright's Page Object Model:

```dart
/// Each component wraps a single screen.
/// - Finders: static Key/text references for widgets on this screen
/// - Actions: tap, enter text, scroll — return void or another component
/// - Assertions: verify* methods that call expect()
/// - Waiters: wait for the screen to be ready before acting

class LoginComponent {
  final PatrolIntegrationTester $;
  LoginComponent(this.$);

  // ── Finders ──
  Finder get emailField    => find.byKey(const Key('email-input'));
  Finder get passwordField => find.byKey(const Key('password-input'));
  Finder get loginButton   => find.byKey(const Key('login-button'));

  // ── Waiters ──
  Future<void> waitUntilVisible() async =>
      pumpUntilFound($, emailField);

  // ── Actions ──
  Future<void> enterEmail(String email) async {
    await $.tester.enterText(emailField, email);
    await $.pump(const Duration(milliseconds: 500));
  }

  Future<void> enterPassword(String password) async {
    await $.tester.enterText(passwordField, password);
    await $.pump(const Duration(milliseconds: 500));
  }

  Future<void> tapLogin() async {
    await $(loginButton).tap(settlePolicy: SettlePolicy.noSettle);
  }

  /// Convenience: fill both fields and tap login in one call.
  Future<void> loginWith(String email, String password) async {
    await enterEmail(email);
    await enterPassword(password);
    await tapLogin();
  }

  // ── Assertions ──
  void verifyVisible() {
    expect(emailField, findsOneWidget, reason: 'Login email field should be visible');
    expect(passwordField, findsOneWidget, reason: 'Login password field should be visible');
    expect(loginButton, findsOneWidget, reason: 'Login button should be visible');
  }
}
```

### Test Example

Tests read like a script — each step is one component call:

```dart
patrolTest('Login flow: welcome → sign in → home', ($) async {
  final app     = AppComponent($);
  final welcome = WelcomeComponent($);
  final login   = LoginComponent($);
  final home    = HomeComponent($);

  await app.launch();
  await welcome.waitUntilVisible();
  welcome.verifyVisible();

  await welcome.tapSignIn();
  await login.waitUntilVisible();

  await login.loginWith(testEmail, testPassword);
  await home.waitUntilVisible();
  home.verifyVisible();
});
```

### Flows (Composed Shortcuts)

For tests that aren't about the login itself but need to start logged in:

```dart
// flows/login_flow.dart
Future<void> launchAndLogin(PatrolIntegrationTester $) async {
  final app     = AppComponent($);
  final welcome = WelcomeComponent($);
  final login   = LoginComponent($);
  final home    = HomeComponent($);

  await app.launch();
  await welcome.waitUntilVisible();
  await welcome.tapSignIn();
  await login.waitUntilVisible();
  await login.loginWith(testEmail, testPassword);
  await home.waitUntilVisible();
}
```

Then a history test just does:

```dart
patrolTest('History screen loads entries', ($) async {
  await launchAndLogin($);

  final nav     = NavBarComponent($);
  final history = HistoryComponent($);

  await nav.tapHistory();
  await history.waitUntilVisible();
  history.verifyVisible();
});
```

## Steps

### 1. Move all existing tests to `integration_test/bak/`

Move: `app_e2e_test.dart`, `multi_account_test.dart`, `accounts_screen_test.dart`, `comprehensive_e2e_test.dart`, `figma_screenshot_capture.dart`, `logging_flow_test.dart`, `location_collection_test.dart`, `auth_provider_integration_test.dart`, `validation_service_integration_test.dart`, `e2e_helpers.dart`

Keep in place: `login_flow_test.dart`, `test_bundle.dart`

### 2. Create `helpers/`

**`helpers/pump.dart`** — Write from scratch:
- `pumpUntilFound($, finder, {timeout: 30s, interval: 250ms})`
- `pumpUntilGone($, finder, {timeout: 30s, interval: 250ms})`
- `settle($, {frames: 40, interval: 250ms})` — extra settle after navigation

**`helpers/config.dart`** — Write from scratch:
- `const testEmail`, `const testPassword`
- `const defaultPatrolConfig` (`PatrolTesterConfig`)
- `const defaultNativeConfig` (`NativeAutomatorConfig`)

### 3. Create `components/`

Write each component from scratch using the Key registry from the app source.

**`components/app.dart`** — `AppComponent`
- `launch()` — calls `app.main()`, guards against double-launch via `_launched` flag
- `reset()` — for future use (sign out + re-launch flow)

**`components/welcome.dart`** — `WelcomeComponent`
- Finders: `find.text('Welcome to Ash Trail')`, `find.byKey(Key('sign_in_button'))`
- Actions: `tapSignIn()`
- Assertions: `verifyVisible()`

**`components/login.dart`** — `LoginComponent`
- Finders: `email-input`, `password-input`, `login-button`
- Actions: `enterEmail()`, `enterPassword()`, `tapLogin()`, `loginWith(email, pass)`
- Assertions: `verifyVisible()`, `verifyError(message)` — checks error container shown

**`components/home.dart`** — `HomeComponent`
- Finders: `app_bar_home`, `nav_home`, `hold_to_record_button`, `quick_log_mood_slider`, `quick_log_physical_slider`, `time_since_last_hit`, `app_bar_account`, `fab_backdate`
- Actions: `tapAccountIcon()`, `tapBackdateFab()`, `holdToRecord({duration})`, `setMoodSlider(value)`, `setPhysicalSlider(value)`
- Assertions: `verifyVisible()`, `verifyQuickLogVisible()`, `verifyTimeSinceLastVisible()`

**`components/nav_bar.dart`** — `NavBarComponent`
- Finders: `nav_home`, `nav_analytics`, `nav_history`, `nav_log`
- Actions: `tapHome()`, `tapAnalytics()`, `tapHistory()`, `tapLog()`
- Assertions: `verifyVisible()`

**`components/history.dart`** — `HistoryComponent`
- Finders: `app_bar_history`, `history_filter_button`, `history_group_button`, `history_search`
- Actions: `tapFilter()`, `tapGroup()`, `searchFor(text)`
- Assertions: `verifyVisible()`, `verifyHasEntries()`, `verifyEmpty()`

**`components/analytics.dart`** — `AnalyticsComponent`
- Finders: `app_bar_analytics`
- Actions: (future: tap chart segments, change date range)
- Assertions: `verifyVisible()`

**`components/logging.dart`** — `LoggingComponent`
- Finders: `app_bar_logging`, `tab_detailed`, `tab_backdate`
- Actions: `tapDetailedTab()`, `tapBackdateTab()`
- Assertions: `verifyVisible()`

**`components/accounts.dart`** — `AccountsComponent`
- Finders: `app_bar_accounts`, `accounts_add_account`, `account_card_0`, `account_card_1`
- Actions: `tapAddAccount()`, `tapAccountCard(index)`
- Assertions: `verifyVisible()`, `verifyAccountCount(n)`

### 4. Create `flows/login_flow.dart`

Compose `AppComponent` → `WelcomeComponent` → `LoginComponent` → `HomeComponent` into `launchAndLogin($)`.

### 5. Rewrite `login_flow_test.dart`

Use the new components and flow. Run on simulator, confirm it passes.

### 6. Add test suites incrementally

Build one at a time. Each test file runs independently. Confirm each passes before moving to the next.

| Priority | File | Tests | Components Used |
|----------|------|-------|-----------------|
| 1 | `login_flow_test.dart` | Login flow (already working) | App, Welcome, Login, Home |
| 2 | `navigation_test.dart` | All 4 nav tabs reachable, correct screen shows | App, Welcome, Login, Home, NavBar, History, Analytics, Logging |
| 3 | `home_screen_test.dart` | Quick-log visible, hold-to-record, sliders, time-since-last | Home |
| 4 | `history_test.dart` | History loads, search, filter | NavBar, History |
| 5 | `accounts_test.dart` | Accounts loads, cards visible, add account | Home, Accounts |
| 6 | `analytics_test.dart` | Analytics loads, stats shown | NavBar, Analytics |
| 7 | `logging_test.dart` | Tabs visible, can switch tabs | NavBar, Logging |

## Decisions

- **Fresh start**: All component and test code is written from scratch. Old tests in `bak/` are reference only.
- **Patrol only**: No `IntegrationTestWidgetsFlutterBinding` / `testWidgets`. Service-layer tests belong in `test/`, not `integration_test/`.
- **Key-based finders only**: No icon or text-based navigation. Every interactive widget in the app already has a `Key()`.
- **No silent assertions**: Tests fail loudly with descriptive `reason` strings.
- **Single `app.main()` call**: `AppComponent.launch()` guards with a `_launched` flag.
- **Component → Flow → Test layering**: Components are atomic. Flows compose components. Tests call flows + make assertions.

---

## App Key Registry (What Components Can Target)

Every component's finders are drawn from the `Key()` constants already in the app source. This is the complete registry.

### WelcomeScreen (main.dart)
| Key | Widget |
|-----|--------|
| `sign_in_button` | FilledButton.icon — navigate to LoginScreen |

### LoginScreen (login_screen.dart)
| Key | Widget |
|-----|--------|
| `email-input` | TextFormField — email |
| `password-input` | TextFormField — password |
| `login-button` | ElevatedButton — submit login |

### SignupScreen (signup_screen.dart)
| Key | Widget |
|-----|--------|
| `email-input` | TextFormField — email |
| `username-input` | TextFormField — username |
| `password-input` | TextFormField — password |
| `confirm-password-input` | TextFormField — confirm password |
| `signup-button` | ElevatedButton — submit signup |

### MainNavigation (main_navigation.dart)
| Key | Widget |
|-----|--------|
| `nav_home` | NavigationDestination — Home tab |
| `nav_analytics` | NavigationDestination — Analytics tab |
| `nav_history` | NavigationDestination — History tab |
| `nav_log` | NavigationDestination — Log tab |

### HomeScreen (home_screen.dart)
| Key | Widget |
|-----|--------|
| `app_bar_home` | AppBar |
| `app_bar_edit_layout` | IconButton — toggle edit mode |
| `app_bar_account` | SemanticIconButton — navigate to Accounts |
| `fab_backdate` | FloatingActionButton.small |
| `add_account_button` | FilledButton.icon (no-account state) |
| `add_widget_button` | FilledButton.icon (edit mode) |

### Home Widgets
| Key | Widget | File |
|-----|--------|------|
| `quick_log_clear_form` | Button | home_quick_log_widget.dart |
| `quick_log_mood_slider` | Slider | home_quick_log_widget.dart |
| `quick_log_physical_slider` | Slider | home_quick_log_widget.dart |
| `quick_log_reasons` | Container | home_quick_log_widget.dart |
| `hold_to_record_button` | GestureDetector | home_quick_log_widget.dart |
| `time_since_last_hit` | Container | time_since_last_hit_widget.dart |

### AnalyticsScreen (analytics_screen.dart)
| Key | Widget |
|-----|--------|
| `app_bar_analytics` | AppBar |

### HistoryScreen (history_screen.dart)
| Key | Widget |
|-----|--------|
| `app_bar_history` | AppBar |
| `history_filter_button` | IconButton |
| `history_group_button` | PopupMenuButton |
| `history_search` | TextField |

### LoggingScreen (logging_screen.dart)
| Key | Widget |
|-----|--------|
| `app_bar_logging` | AppBar |
| `tab_detailed` | Tab |
| `tab_backdate` | Tab |
| `logging_clear_button` | OutlinedButton |
| `logging_log_event_button` | FilledButton |

### AccountsScreen (accounts_screen.dart)
| Key | Widget |
|-----|--------|
| `app_bar_accounts` | AppBar |
| `accounts_export_button` | IconButton |
| `accounts_add_account_card` | Card |
| `accounts_add_account` | ListTile |
| `account_card_$N` | Card (dynamic per account index) |

### ExportScreen (export_screen.dart)
| Key | Widget |
|-----|--------|
| `app_bar_export` | AppBar |

### Dialogs
| Key | Widget | File |
|-----|--------|------|
| `edit_dialog_cancel` | Button | edit_log_record_dialog.dart |
| `edit_dialog_update` | Button | edit_log_record_dialog.dart |
| `backdate_dialog_cancel` | Button | backdate_dialog.dart |
| `backdate_dialog_create` | Button | backdate_dialog.dart |

---

## Key Gaps (Screens That Need Keys Added Before Testing)

These screens lack `Key()` constants on interactive elements, making them untestable with key-based finders. Keys should be added to the app source before writing the corresponding test.

| Screen | What's Missing | Priority |
|--------|---------------|----------|
| **LoggingScreen — Detailed Tab form** | EventType dropdown, duration TextField, notes TextField, mood slider, physical slider, reason chips, press-and-hold circle | High — needed for `logging_test.dart` |
| **HistoryScreen — Record items** | Individual record tiles (use `Key('history_record_$logId')`) | High — needed for `history_test.dart` edit/delete |
| **HistoryScreen — Filter sheet** | FilterChip items, date range, Clear All, Done buttons | Medium |
| **HistoryScreen — Edit/Delete icons** | Per-row edit and delete icon buttons | Medium |
| **AnalyticsScreen — Content** | Stat cards, chart container, recent entries | Medium — needed for `analytics_test.dart` |
| **AccountsScreen — Per-card actions** | Sign Out / Delete popup menu items | Medium |
| **ExportScreen — Buttons** | CSV export, JSON export, import buttons | Low |
| **ProfileScreen** | **Zero keys** — completely keyless | Low (no test planned yet) |

---

## Old Test Scenarios → New Test File Mapping

### E2E-Testable Scenarios (66 total from old tests)

These test real user interactions through the UI and belong in `integration_test/`.

#### `login_flow_test.dart` — Priority 1 ✅ (already working)
| Scenario | Description |
|----------|-------------|
| Launch app → Welcome → Sign In → Home | Core auth flow |

#### `auth_test.dart` — Priority 2
| Scenario | From Old File | Description |
|----------|--------------|-------------|
| Welcome screen displays branding | app_e2e_test #5 | "Welcome to Ash Trail" text, fire icon, "Sign In" button |
| Sign In navigates to Login screen | app_e2e_test #4 | Tap sign_in_button → Login screen visible |
| Login screen shows all auth options | app_e2e_test #4 | Email fields, Google, Apple buttons visible |
| Login with bad credentials shows error | — (new) | Enter invalid email/pass → error container shown |
| **Prerequisite keys**: None needed — all keys exist |

#### `navigation_test.dart` — Priority 3
| Scenario | From Old File | Description |
|----------|--------------|-------------|
| All 4 nav tabs reachable | app_e2e_test #2 | Tap each nav tab → correct screen AppBar shown |
| Nav cycle doesn't crash | app_e2e_test #2 | Home→History→Analytics→Log→Home completes |
| Rapid navigation is stable | app_e2e_test #39 | Toggle tabs 3× rapidly → no crash |
| **Prerequisite keys**: None needed |

#### `home_screen_test.dart` — Priority 4
| Scenario | From Old File | Description |
|----------|--------------|-------------|
| Home screen displays AppBar and content | app_e2e_test #3, #7 | `app_bar_home` visible, time-since-last widget |
| Quick log widget visible with sliders | app_e2e_test #8, #9, #10 | `quick_log_mood_slider`, `quick_log_physical_slider` exist |
| Hold-to-record creates entry | app_e2e_test #13, multi_account #51 | Long-press `hold_to_record_button` → SnackBar shown |
| Quick log with sliders + hold creates entry and updates UI | app_e2e_test #13 | Set sliders → hold → time-since-last resets → History has entry |
| Accounts icon navigates to Accounts | app_e2e_test #6 | Tap `app_bar_account` → Accounts screen |
| **Prerequisite keys**: None needed |

#### `history_test.dart` — Priority 5
| Scenario | From Old File | Description |
|----------|--------------|-------------|
| History screen loads | app_e2e_test #21, #22 | `app_bar_history` visible, shows entries or empty state |
| Search field exists | app_e2e_test #23 | `history_search` visible |
| Filter button exists | app_e2e_test #23 | `history_filter_button` visible |
| Group button exists | app_e2e_test #24 | `history_group_button` visible |
| Tap entry opens edit dialog | app_e2e_test #25 | Tap record → `edit_dialog_update` and `edit_dialog_cancel` visible |
| Cancel closes dialog | app_e2e_test #38 | Tap `edit_dialog_cancel` → dialog gone |
| **Prerequisite keys needed**: `history_record_$logId` on record tiles for reliable tap targeting |

#### `accounts_test.dart` — Priority 6
| Scenario | From Old File | Description |
|----------|--------------|-------------|
| Accounts screen loads without spinner | accounts_screen #56 | `app_bar_accounts` visible, no `CircularProgressIndicator` |
| Account card displays | accounts_screen #58, multi_account #46 | `account_card_0` visible |
| Active account indicated | accounts_screen #59, multi_account #47 | "Active" text visible |
| Add account navigates to login | accounts_screen #57, multi_account #44 | Tap `accounts_add_account` → Login screen |
| **Prerequisite keys**: None needed |

#### `multi_account_test.dart` — Priority 7 (requires 2 test accounts in Firebase)
| Scenario | From Old File | Description |
|----------|--------------|-------------|
| Add second account | multi_account #44 | Tap `accounts_add_account` → login with account2 → back to accounts |
| Switch accounts | multi_account #48 | Tap `account_card_1` → account switches |
| Switch updates Home context | multi_account #49 | Switch → navigate Home → displays correctly |
| Switch back to first account | multi_account #50 | Tap `account_card_0` → restores |
| Data isolation between accounts | multi_account #52 | Log on acct1 → switch acct2 → history different |
| Rapid switching doesn't crash | multi_account #55 | Toggle accounts 5× → stable |
| **Prerequisite keys**: None needed |

#### `analytics_test.dart` — Priority 8
| Scenario | From Old File | Description |
|----------|--------------|-------------|
| Analytics screen loads | app_e2e_test #26 | `app_bar_analytics` visible |
| Stats content shown | app_e2e_test #27 | "Total"/"Count" text or stat widgets visible |
| Charts render without crash | app_e2e_test #28 | Pump 3s, no crash |
| **Prerequisite keys needed**: Stat cards and chart container keys for robust assertions |

#### `logging_test.dart` — Priority 9
| Scenario | From Old File | Description |
|----------|--------------|-------------|
| Logging screen loads with tabs | app_e2e_test #14 | `app_bar_logging`, `tab_detailed`, `tab_backdate` visible |
| Log Event button exists | app_e2e_test #19 | `logging_log_event_button` visible |
| Clear button exists | app_e2e_test #20 | `logging_clear_button` visible |
| Can switch tabs | app_e2e_test #18 | Tap `tab_backdate` → backdate content shown |
| **Prerequisite keys needed**: EventType dropdown, duration/notes fields, form sliders |

### Service-Layer Tests to Move to `test/` (38 scenarios)

These tests don't interact with the UI at all — they call `LogRecordService` and `LocationService` directly. They should move from `integration_test/` to `test/services/`.

| Source File | Scenarios | Move To |
|-------------|-----------|---------|
| comprehensive_e2e_test.dart | #62–88 (CRUD, queries, stats, edge cases, concurrency) | `test/services/log_record_service_test.dart` |
| logging_flow_test.dart | #90–98 (duplicate of above) | Delete — redundant with above |
| location_collection_test.dart | #108–109 (permission check service) | `test/services/location_service_test.dart` |

### Screenshot Utility (not a test)

| Source File | Action |
|-------------|--------|
| figma_screenshot_capture.dart | Move to `bak/`. Can be rebuilt later as a utility using components if needed |

---

## Component → Test Dependency Matrix

Shows which component is needed by which test file.

| Component | login_flow | auth | navigation | home | history | accounts | multi_account | analytics | logging |
|-----------|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
| `AppComponent` | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ |
| `WelcomeComponent` | ✓ | ✓ | — | — | — | — | — | — | — |
| `LoginComponent` | ✓ | ✓ | — | — | — | — | ✓ | — | — |
| `HomeComponent` | ✓ | — | ✓ | ✓ | — | ✓ | ✓ | — | — |
| `NavBarComponent` | — | — | ✓ | — | ✓ | — | ✓ | ✓ | ✓ |
| `HistoryComponent` | — | — | ✓ | ✓ | ✓ | — | ✓ | — | — |
| `AnalyticsComponent` | — | — | ✓ | — | — | — | — | ✓ | — |
| `LoggingComponent` | — | — | ✓ | — | — | — | — | — | ✓ |
| `AccountsComponent` | — | — | — | — | — | ✓ | ✓ | — | — |
| `LoginFlow` (flow) | — | — | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ |

---

## Execution Order

Build in this order so each step validates the components the next step depends on:

1. **helpers/** → `pump.dart`, `config.dart`
2. **components/** → `app.dart`, `welcome.dart`, `login.dart`, `home.dart`, `nav_bar.dart`
3. **flows/** → `login_flow.dart`
4. **Rewrite** `login_flow_test.dart` → run, confirm pass ✅
5. **Write** `auth_test.dart` → run, confirm pass
6. **Write** `navigation_test.dart` — also creates `history.dart`, `analytics.dart`, `logging.dart` components → run, confirm pass
7. **Write** `home_screen_test.dart` → run, confirm pass
8. **Write** `history_test.dart` — may need to add keys to app source first → run, confirm pass
9. **Write** `accounts_test.dart` — creates `accounts.dart` component → run, confirm pass
10. **Write** `multi_account_test.dart` — extends `login.dart` component for 2nd account → run, confirm pass
11. **Write** `analytics_test.dart` → run, confirm pass
12. **Write** `logging_test.dart` — may need to add keys to app source first → run, confirm pass
13. **Move** service-layer tests to `test/services/` and verify with `flutter test`
