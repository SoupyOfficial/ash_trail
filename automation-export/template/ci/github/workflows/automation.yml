name: automation

on:
  pull_request:
    paths:
      - "**.py"
      - "**.js"
      - "**.ts"
      - "**.java"
      - "**.kt"
      - "**.go"
      - "**.rs"
      - "**.cs"
      - "**.dart"
      - "pyproject.toml"
      - "requirements*.txt"
      - "package*.json"
      - "pom.xml"
      - "build.gradle*"
      - "go.mod"
      - "go.sum"
      - "Cargo.toml"
      - "Cargo.lock"
      - "pubspec.yaml"
      - "pubspec.lock"
      - "**.csproj"
      - "**.sln"
      - "**.fsproj"
      - "automation.config.yaml"
      - "scripts/**"
      - ".github/workflows/**"
      - "ci/**"
      - "tests/**"
      - "test/**"
      - "spec/**"
  push:
    branches: [main, master, develop]
    paths:
      - "**.py"
      - "**.js"
      - "**.ts"
      - "**.java"
      - "**.kt"
      - "**.go"
      - "**.rs"
      - "**.cs"
      - "**.dart"
      - "pyproject.toml"
      - "requirements*.txt"
      - "package*.json"
      - "pom.xml"
      - "build.gradle*"
      - "go.mod"
      - "go.sum"
      - "Cargo.toml"
      - "Cargo.lock"
      - "pubspec.yaml"
      - "pubspec.lock"
      - "**.csproj"
      - "**.sln"
      - "**.fsproj"
      - "automation.config.yaml"
      - "scripts/**"
      - ".github/workflows/**"
      - "ci/**"
  schedule:
    - cron: "0 6 * * 1" # Weekly on Monday at 6 AM UTC

# Minimal permissions
permissions:
  contents: read
  issues: write
  pull-requests: write
  security-events: write

# Concurrency group - cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # Coverage thresholds
  COVERAGE_GLOBAL_THRESHOLD: "80"
  COVERAGE_PATCH_THRESHOLD: "85"

  # Codecov configuration
  CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

jobs:
  # Language detection and matrix preparation
  detect:
    name: Detect Project Language
    runs-on: ubuntu-latest
    outputs:
      language: ${{ steps.detect.outputs.language }}
      os-matrix: ${{ steps.matrix.outputs.os-matrix }}
      language-versions: ${{ steps.matrix.outputs.language-versions }}
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Detect Language
        id: detect
        run: |
          if [ -f "pyproject.toml" ] || [ -f "requirements.txt" ] || [ -f "setup.py" ]; then
            echo "language=python" >> $GITHUB_OUTPUT
          elif [ -f "pom.xml" ] || [ -f "build.gradle" ] || [ -f "build.gradle.kts" ]; then
            echo "language=java" >> $GITHUB_OUTPUT
          elif [ -f "package.json" ]; then
            echo "language=node" >> $GITHUB_OUTPUT
          elif [ -f "go.mod" ]; then
            echo "language=go" >> $GITHUB_OUTPUT
          elif [ -f "pubspec.yaml" ]; then
            echo "language=flutter" >> $GITHUB_OUTPUT
          elif [ -f "Cargo.toml" ]; then
            echo "language=rust" >> $GITHUB_OUTPUT
          elif find . -maxdepth 2 -name "*.csproj" -o -name "*.sln" -o -name "*.fsproj" | head -1 | grep -q .; then
            echo "language=csharp" >> $GITHUB_OUTPUT
          else
            echo "language=unknown" >> $GITHUB_OUTPUT
          fi

      - name: Setup Matrix
        id: matrix
        run: |
          # Default OS matrix
          echo 'os-matrix=["ubuntu-latest", "windows-latest"]' >> $GITHUB_OUTPUT

          # Language version matrix based on detected language
          case "${{ steps.detect.outputs.language }}" in
            python)
              echo 'language-versions=["3.9", "3.10", "3.11"]' >> $GITHUB_OUTPUT
              ;;
            java)
              echo 'language-versions=["11", "17", "21"]' >> $GITHUB_OUTPUT
              ;;
            node)
              echo 'language-versions=["16", "18", "20"]' >> $GITHUB_OUTPUT
              ;;
            go)
              echo 'language-versions=["1.19", "1.20", "1.21"]' >> $GITHUB_OUTPUT
              ;;
            flutter)
              echo 'language-versions=["stable"]' >> $GITHUB_OUTPUT
              ;;
            rust)
              echo 'language-versions=["stable"]' >> $GITHUB_OUTPUT
              ;;
            csharp)
              echo 'language-versions=["6.0", "7.0", "8.0"]' >> $GITHUB_OUTPUT
              ;;
            *)
              echo 'language-versions=["default"]' >> $GITHUB_OUTPUT
              ;;
          esac

  # Environment health check
  doctor:
    name: Health Check
    needs: detect
    strategy:
      fail-fast: false
      matrix:
        os: ${{ fromJson(needs.detect.outputs.os-matrix) }}
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3.6.0

      - name: Setup Language Environment
        uses: ./.github/actions/setup-language
        with:
          language: ${{ needs.detect.outputs.language }}
          version: ${{ fromJson(needs.detect.outputs.language-versions)[0] }}

      - name: Run Doctor (Unix)
        if: runner.os != 'Windows'
        run: ./scripts/doctor.sh

      - name: Run Doctor (Windows)
        if: runner.os == 'Windows'
        run: .\scripts\doctor.ps1

  # Code linting and formatting
  lint:
    name: Lint & Format
    needs: detect
    strategy:
      fail-fast: false
      matrix:
        os: ${{ fromJson(needs.detect.outputs.os-matrix) }}
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3.6.0

      - name: Setup Language Environment
        uses: ./.github/actions/setup-language
        with:
          language: ${{ needs.detect.outputs.language }}
          version: ${{ fromJson(needs.detect.outputs.language-versions)[0] }}

      - name: Run Linting (Unix)
        if: runner.os != 'Windows'
        run: ./scripts/lint.sh

      - name: Run Linting (Windows)
        if: runner.os == 'Windows'
        run: .\scripts\lint.ps1

  # Test execution with coverage
  test:
    name: Test
    needs: detect
    strategy:
      fail-fast: false
      matrix:
        os: ${{ fromJson(needs.detect.outputs.os-matrix) }}
        language-version: ${{ fromJson(needs.detect.outputs.language-versions) }}
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3.6.0
        with:
          fetch-depth: 0 # Full history for coverage comparison

      - name: Setup Language Environment
        uses: ./.github/actions/setup-language
        with:
          language: ${{ needs.detect.outputs.language }}
          version: ${{ matrix.language-version }}

      - name: Run Tests with Coverage (Unix)
        if: runner.os != 'Windows'
        run: ./scripts/test.sh --coverage

      - name: Run Tests with Coverage (Windows)
        if: runner.os == 'Windows'
        run: .\scripts\test.ps1 -Coverage

      - name: Check Coverage Threshold
        run: |
          # Find coverage file
          if [ -f "coverage/lcov.info" ]; then
            COVERAGE_FILE="coverage/lcov.info"
          elif [ -f "coverage/coverage-final.json" ]; then
            COVERAGE_FILE="coverage/coverage-final.json"
          else
            echo "No coverage file found, skipping threshold check"
            exit 0
          fi

          # Extract coverage percentage (simplified)
          if [[ "$COVERAGE_FILE" == *.lcov* ]]; then
            HIT_LINES=$(grep -c "^DA:.*,1$" "$COVERAGE_FILE" || echo "0")
            TOTAL_LINES=$(grep -c "^DA:" "$COVERAGE_FILE" || echo "1")
            COVERAGE_PCT=$(awk -v h="$HIT_LINES" -v t="$TOTAL_LINES" 'BEGIN { printf("%.1f", (h/t)*100) }')
          else
            echo "Coverage format not supported for threshold check"
            exit 0
          fi

          echo "coverage_pct=$COVERAGE_PCT" >> $GITHUB_ENV
          echo "Coverage: $COVERAGE_PCT%"

          # Check threshold
          if awk -v p="$COVERAGE_PCT" -v t="$COVERAGE_GLOBAL_THRESHOLD" 'BEGIN { exit (p+0>=t)?0:1 }'; then
            echo "‚úÖ Coverage $COVERAGE_PCT% meets threshold of $COVERAGE_GLOBAL_THRESHOLD%"
          else
            echo "‚ùå Coverage $COVERAGE_PCT% below threshold of $COVERAGE_GLOBAL_THRESHOLD%"
            exit 1
          fi
        shell: bash

      - name: Upload Coverage to Codecov
        if: matrix.os == 'ubuntu-latest' && matrix.language-version == fromJson(needs.detect.outputs.language-versions)[0]
        uses: codecov/codecov-action@e28ff129e5465c2c0dcc6f003fc735cb6ae0c673 # v4.5.0
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: |
            coverage/lcov.info
            coverage/coverage-final.json
            coverage.xml
            coverage.out
            target/site/jacoco/jacoco.xml
            build/reports/jacoco/test/jacocoTestReport.xml
            cobertura.xml
          flags: |
            ${{ needs.detect.outputs.language }}
            unittests
            ${{ matrix.os }}
          name: coverage-${{ needs.detect.outputs.language }}-${{ matrix.language-version }}-${{ matrix.os }}
          fail_ci_if_error: false
          verbose: true
          override_branch: ${{ github.head_ref || github.ref_name }}
          override_commit: ${{ github.event.pull_request.head.sha || github.sha }}
          override_pr: ${{ github.event.pull_request.number }}

      - name: Upload Coverage with Dev Assistant
        if: matrix.os == 'ubuntu-latest' && matrix.language-version == fromJson(needs.detect.outputs.language-versions)[0]
        run: |
          # Try using dev assistant upload-coverage command as fallback
          if [ -f "scripts/dev_assistant.py" ]; then
            echo "üîÑ Attempting coverage upload via dev assistant..."
            python scripts/dev_assistant.py upload-coverage \
              --token "${{ secrets.CODECOV_TOKEN }}" \
              --flags "${{ needs.detect.outputs.language }}" "unittests" "${{ matrix.os }}" || true
          fi
        shell: bash
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: Comment Coverage on PR
        if: github.event_name == 'pull_request' && matrix.os == 'ubuntu-latest' && matrix.language-version == fromJson(needs.detect.outputs.language-versions)[0]
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const marker = '<!-- coverage-report -->';
            const pct = process.env.coverage_pct || 'n/a';
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;

            // Find existing coverage comment
            const comments = await github.paginate(github.rest.issues.listComments, {
              owner, repo, issue_number, per_page: 100
            });

            for (const c of comments) {
              if (c.user.type === 'Bot' && c.body && c.body.includes(marker)) {
                await github.rest.issues.deleteComment({owner, repo, comment_id: c.id});
              }
            }

            // Create new coverage comment
            const body = `${marker}
            **üß™ Test Coverage Report**

            **Overall Coverage:** ${pct}% (minimum: ${process.env.COVERAGE_GLOBAL_THRESHOLD}%)
            **Language:** ${{ needs.detect.outputs.language }}
            **OS:** ${{ matrix.os }}
            **Version:** ${{ matrix.language-version }}
            **Codecov Report:** [View detailed report](https://codecov.io/${{ github.repository }})

            üìä **Coverage uploaded to Codecov with flags:**
            - \`${{ needs.detect.outputs.language }}\`
            - \`unittests\`
            - \`${{ matrix.os }}\`
            `;

            await github.rest.issues.createComment({owner, repo, issue_number, body});

  # Build verification
  build:
    name: Build
    needs: [detect, lint, test]
    strategy:
      fail-fast: false
      matrix:
        os: ${{ fromJson(needs.detect.outputs.os-matrix) }}
        include:
          - os: ubuntu-latest
            build-mode: debug
          - os: ubuntu-latest
            build-mode: release
          - os: windows-latest
            build-mode: debug
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3.6.0

      - name: Setup Language Environment
        uses: ./.github/actions/setup-language
        with:
          language: ${{ needs.detect.outputs.language }}
          version: ${{ fromJson(needs.detect.outputs.language-versions)[0] }}

      - name: Run Build (Unix)
        if: runner.os != 'Windows'
        run: |
          if [ "${{ matrix.build-mode }}" = "release" ]; then
            ./scripts/build.sh --release
          else
            ./scripts/build.sh
          fi

      - name: Run Build (Windows)
        if: runner.os == 'Windows'
        run: |
          if ("${{ matrix.build-mode }}" -eq "release") {
            .\scripts\build.ps1 -Release
          } else {
            .\scripts\build.ps1
          }
        shell: pwsh

      - name: Upload Build Artifacts
        if: matrix.build-mode == 'release'
        uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3 # v4.3.1
        with:
          name: build-${{ needs.detect.outputs.language }}-${{ matrix.os }}
          path: |
            build/
            dist/
            target/
            out/
          retention-days: 7

  # Security scanning
  security:
    name: Security Scan
    needs: detect
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3.6.0

      - name: Setup Language Environment
        uses: ./.github/actions/setup-language
        with:
          language: ${{ needs.detect.outputs.language }}
          version: ${{ fromJson(needs.detect.outputs.language-versions)[0] }}

      - name: Run Security Scan
        run: |
          case "${{ needs.detect.outputs.language }}" in
            python)
              if command -v safety >/dev/null 2>&1; then
                safety check
              elif command -v pip-audit >/dev/null 2>&1; then
                pip-audit
              fi
              ;;
            java)
              if command -v mvn >/dev/null 2>&1; then
                mvn dependency-check:check || true
              elif command -v gradle >/dev/null 2>&1; then
                gradle dependencyCheckAnalyze || true
              fi
              ;;
            node)
              npm audit || true
              ;;
            go)
              if command -v govulncheck >/dev/null 2>&1; then
                govulncheck ./...
              fi
              ;;
            rust)
              if command -v cargo-audit >/dev/null 2>&1; then
                cargo audit
              fi
              ;;
            *)
              echo "No security scanning configured for ${{ needs.detect.outputs.language }}"
              ;;
          esac

  # Final summary
  summary:
    name: Summary
    needs: [detect, doctor, lint, test, build, security]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate Summary
        run: |
          echo "## üöÄ Automation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Language:** ${{ needs.detect.outputs.language }}" >> $GITHUB_STEP_SUMMARY
          echo "**Doctor:** ${{ needs.doctor.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Lint:** ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Test:** ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build:** ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Security:** ${{ needs.security.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.doctor.result }}" = "success" ] && [ "${{ needs.lint.result }}" = "success" ] && [ "${{ needs.test.result }}" = "success" ] && [ "${{ needs.build.result }}" = "success" ]; then
            echo "‚úÖ **All checks passed!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Some checks failed. Please review the logs above.**" >> $GITHUB_STEP_SUMMARY
          fi
