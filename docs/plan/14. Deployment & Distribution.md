## 14. Deployment & Distribution

### 14.1 Build Process

#### Overview
Defines how AshTrail is built locally and prepared for platform-specific distribution. This section exists to ensure builds are reproducible, debuggable, and aligned with environment constraints.

#### Responsibilities
- Produce deterministic builds for development and release
- Separate debug/dev artifacts from production artifacts
- Enforce environment-specific configuration boundaries
- Ensure build outputs match platform store requirements

#### Data Structures
_Not applicable._  
Build configuration is defined via Flutter tooling and environment flags rather than runtime data structures.

#### State & Flow
1. Developer invokes a local build command (`flutter run` / `flutter build`)
2. Build flavor determines:
   - Environment configuration
   - Logging verbosity
   - Feature availability
3. Flutter toolchain compiles Dart → platform-specific artifacts
4. Artifacts are either:
   - Installed locally (debug)
   - Prepared for store upload (release)

#### Edge Cases & Failure Modes
- Mismatched Flutter SDK version causes build failure
- Incorrect environment flags may:
  - Point production builds at dev services
  - Enable debug-only features in release
- Platform-specific signing issues block release builds

#### Future Extensions
- CI-based build automation (GitHub Actions / GitLab CI)
- Reproducible build verification via checksums
- Build metadata injection (commit hash, build time)

---

#### 14.1.1 Local Builds

#### Local Builds Overview
Local builds are used for development, debugging, and manual QA prior to distribution.

#### Local Builds Responsibilities
- Enable fast iteration during development
- Allow platform-specific testing without store deployment
- Surface runtime errors early

#### Local Builds State Flow
- Common commands:
  - `flutter run` (debug, hot reload enabled)
  - `flutter build apk` / `flutter build ios`
- Build flavor selected via:
  - Dart defines
  - Flavor-specific entrypoints (if applicable)

#### Local Builds Assumptions
- Developers have the correct Flutter SDK installed
- Platform SDKs (Android Studio / Xcode) are properly configured

#### Local Builds Open Questions
- Are multiple Flutter flavors currently defined, or is a single entrypoint used with runtime flags?
- Is there a canonical build command documented for contributors?

---

### 14.2 Platform Deployment

#### Platform Deployment Overview
Covers how AshTrail is packaged and distributed to end users via platform-specific app stores.

#### Platform Deployment Responsibilities
- Produce store-compliant binaries
- Manage signing and provisioning
- Ensure store metadata aligns with app behavior

---

#### 14.2.1 Android

#### Android Deployment Overview
Android builds are distributed via APK/AAB artifacts and installed through the Play Store or sideloading for testing.

#### Android Deployment Responsibilities
- Generate signed release builds
- Manage application ID and version codes
- Comply with Play Store policies

#### Android Deployment State Flow
1. `flutter build appbundle` or `flutter build apk`
2. Gradle handles:
   - Signing configuration
   - Version code/name injection
3. Output uploaded to:
   - Play Console (production/testing)
   - Direct install for internal testing

#### Android Deployment Edge Cases & Failure Modes
- Incorrect keystore configuration blocks release builds
- Version code reuse rejected by Play Store
- ABI misconfiguration increases binary size or breaks installs

#### Android Deployment Assumptions
- Android signing keys are stored securely and backed up
- Play Store is the primary distribution channel

---

#### 14.2.2 iOS

#### iOS Deployment Overview
iOS builds are distributed through TestFlight and the App Store.

#### iOS Deployment Responsibilities
- Manage certificates and provisioning profiles
- Ensure App Store compliance
- Handle Apple-specific build constraints

#### iOS Deployment State Flow
1. `flutter build ios` (release)
2. Xcode performs:
   - Code signing
   - Archive generation
3. Archive uploaded via:
   - Xcode Organizer
   - Transporter
4. Distribution through TestFlight → App Store

#### iOS Deployment Edge Cases & Failure Modes
- Expired certificates prevent builds
- Provisioning profile mismatch blocks signing
- App Store review rejection due to policy violations

#### iOS Deployment Assumptions
- Apple Developer account is active
- iOS deployment target matches supported devices

---

### 14.3 Versioning

#### Versioning Overview
Defines how application versions and internal schemas evolve over time without breaking existing users.

#### Versioning Responsibilities
- Track application releases
- Maintain backward compatibility where required
- Coordinate app version with data schema version

---

#### 14.3.1 Schema Versioning

#### Schema Versioning Overview
Schema versioning ensures persisted data remains readable across app updates.

#### Schema Versioning Responsibilities
- Identify breaking changes to local data models
- Migrate or invalidate incompatible data safely
- Prevent silent data corruption

#### Schema Versioning Data Structures
- **Schema Version**
  - Type: integer
  - Scope: local persistence layer
  - Stored alongside persisted data

#### Schema Versioning State Flow
1. App startup reads persisted schema version
2. Current app schema version is compared
3. If versions differ:
   - Compatible → migrate
   - Incompatible → reset or block load
4. Updated schema version is persisted

#### Schema Versioning Edge Cases & Failure Modes
- Downgrade to older app version cannot read newer schema
- Partial migrations leave data in inconsistent state
- Missing schema version defaults incorrectly

#### Schema Versioning Assumptions
- Local persistence supports schema metadata
- Migrations are deterministic and idempotent

#### Schema Versioning Open Questions
- Are schema migrations currently implemented or planned?
- Is data reset acceptable on breaking schema changes, or must data always be preserved?

#### Schema Versioning Future Extensions
- Formal migration framework
- Per-entity schema versioning
- Migration test coverage

---
