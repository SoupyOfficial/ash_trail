## 19. Time, Locale, and Timezone Handling

### 19.0 Overview

This section defines how AshTrail handles time, dates, timezones, and locale-specific formatting to ensure consistency across logging, aggregation, display, and synchronization.

Time handling is treated as a **core correctness concern** due to:
- Daily aggregations and trends
- Cross-midnight logging behavior
- Offline-first data creation
- Future sync and analytics use cases

---

### 19.1 Responsibilities

The time and locale system is responsible for:

- Ensuring all stored timestamps are unambiguous and comparable
- Providing consistent day-boundary calculations
- Preventing timezone-related data corruption
- Separating **storage concerns** from **display concerns**
- Supporting deterministic analytics and aggregation

Non-responsibilities:
- No timezone conversion at write time beyond normalization
- No historical reinterpretation of timestamps once persisted
- No user-facing timezone configuration (unless explicitly added later)

---

### 19.2 Data Structures

#### 19.2.1 Timestamp Fields

All persisted time values must follow these rules:

| Field | Type | Constraints |
|-----|------|------------|
| `timestampUtc` | `DateTime` | Required, UTC, ISO-8601 |
| `localOffsetMinutes` | `int?` | Optional, captured at creation |
| `localDateKey` | `String` | Required, derived local calendar date |

Notes:
- `timestampUtc` is the **source of truth**
- `localDateKey` is used for daily grouping
- `localOffsetMinutes` is informational and diagnostic

---

### 19.3 State & Flow

#### 19.3.1 Timestamp Creation Flow

1. User initiates a log entry
2. System obtains current time via shared time abstraction
3. Timestamp is normalized to UTC
4. Local offset and derived local date are computed
5. All values are persisted together

Rules:
- `DateTime.now()` must not be called directly
- All time access flows through a single abstraction layer

---

### 19.4 Timezone Strategy

#### 19.4.1 Stored Timezone

- All timestamps are stored in **UTC**
- No local timezone identifiers are persisted
- No automatic migration on timezone changes

Rationale:
- Prevents ambiguity
- Simplifies comparison and sync
- Avoids DST-related corruption

#### 19.4.2 Display Timezone

- UI converts UTC timestamps to **device-local timezone**
- Conversion occurs at render time only
- Aggregations never rely on display-time conversions

---

### 19.5 Day Boundary Rules

#### 19.5.1 Cross-Midnight Sessions

Rules for log entries that span midnight:
- The **start time** determines the `localDateKey`
- Duration is not split across days
- Aggregations respect the assigned `localDateKey`

Explicit non-behavior:
- No automatic session splitting
- No retroactive reassignment

Rationale:
- Predictable behavior
- Simplified analytics
- Matches user mental model of “when it started”

---

### 19.6 Locale Formatting

Locale affects **presentation only**, never storage.

#### 19.6.1 Dates

- Rendered using device locale
- Examples:
  - `MM/DD/YYYY` (US)
  - `DD/MM/YYYY` (EU)
- Internal date keys remain locale-independent

#### 19.6.2 Numbers

- Duration and numeric values formatted using locale rules
- Decimal separators and grouping are presentation-only
- Stored values remain raw numeric types

---

### 19.7 Edge Cases & Failure Modes

#### 19.7.1 DST Transitions

Handled by design via UTC storage:

- DST start/end does not affect stored timestamps
- Local offset is captured at creation time only
- No recalculation occurs post-persistence

Known behaviors:
- A “day” may appear shorter or longer in local display
- Aggregations remain stable and deterministic

---

### 19.8 Assumptions

- Device clock is reasonably accurate
- UTC is acceptable as the canonical time reference
- Users do not require historical timezone reinterpretation

---

### 19.9 Open Questions

- Should time access be injectable for deterministic testing?
- Should `localOffsetMinutes` be required instead of optional?
- Should users be able to override day-boundary behavior?
- Is timezone-aware export needed for external data consumers?

---

### 19.10 Future Extensions

- User-configurable day start offset (e.g., 4am–4am)
- Explicit timezone capture (IANA identifiers)
- Timezone-aware data export options
- Cross-device timezone reconciliation

---
