## 21. Permissions & OS Integration

### 21.1 Overview

This section documents how AshTrail interacts with mobile operating systems (Android and iOS) at the permission and OS-integration level.

Goals:
- Clearly define which OS permissions are required vs optional
- Specify behavior when permissions are missing or revoked
- Document platform-specific differences that affect implementation
- Prevent implicit permission creep or undocumented OS dependencies

AshTrail is designed to be **minimally invasive**:
- Core functionality must work with the smallest permission surface possible
- Optional permissions must degrade gracefully when denied

---

### 21.2 Responsibilities

The permissions and OS integration layer is responsible for:

- Declaring required and optional permissions at build time
- Requesting runtime permissions where applicable
- Detecting permission state changes (granted / denied / revoked)
- Adapting app behavior based on permission availability
- Avoiding crashes or undefined behavior when permissions are missing

---

### 21.3 Required Permissions

#### 21.3.1 Network Access

##### Purpose

- Sync log records with the remote backend
- Authenticate users
- Fetch account metadata

##### Scope

- Outbound HTTPS requests only
- No background socket listeners
- No peer-to-peer networking

##### Platform Details

| Platform | Permission | Notes |
|--------|-----------|------|
| Android | `INTERNET` | Normal permission; auto-granted at install |
| iOS | None explicit | Network access allowed by default; constrained by App Transport Security |

##### Constraints

- App must continue functioning offline if network access is unavailable
- Network failures are treated as transient, not fatal

---

### 21.4 Optional Permissions

#### 21.4.1 Notifications

##### Purpose

- Future reminders or summaries (e.g., daily usage insights)
- Potential alerting for streaks or thresholds

##### Current Status

- Optional
- Not required for core logging or analytics
- Must not block any user flow

##### Platform Details

| Platform | Permission | Notes |
|--------|-----------|------|
| Android | `POST_NOTIFICATIONS` (API 33+) | Runtime permission |
| iOS | User notification authorization | Explicit user prompt required |

##### Behavior When Denied

- No retry loops or repeated prompts
- Feature silently disables itself
- UI should reflect notifications as “off”

---
#### 21.4.2 Location

##### Purpose

- Capture geographic context for log entries
- Enable location-based analytics (e.g., patterns by place)
- Provide optional metadata enrichment

##### Current Status

- Optional
- Not required for core logging
- Must not block any user flow

##### Platform Details

| Platform | Permission | Notes |
|--------|-----------|------|
| Android | `ACCESS_FINE_LOCATION` | Runtime permission; precise coordinates |
| iOS | Location Services (When In Use) | Explicit user prompt required |

##### Precision Level

- Fine/precise location requested for accurate coordinates
- Coarse location is not sufficient for analytics use cases
- Only "when in use" permission is requested; no background location

##### Behavior When Denied

- Location fields remain null on new log entries
- No retry loops or repeated prompts
- UI should clearly indicate location capture is unavailable
- Previously captured locations are preserved

##### Privacy Controls

- Users can disable location capture in app settings
- Location can be cleared from individual entries
- Location data is not shared with third parties

---
### 21.5 Platform Differences

#### 21.5.1 Android

##### Characteristics

- Explicit permission declarations in `AndroidManifest.xml`
- Runtime permission checks required for notifications (API 33+)
- Network permission is implicit and non-revocable

##### Implementation Notes

- Notification permission request must be deferred until feature usage
- Do not request notification permission at app startup

---

#### 21.5.2 iOS

##### Characteristics

- No explicit network permission
- Notification permissions are user-facing and revocable
- OS may silently throttle or suppress notifications

##### Implementation Notes

- App must handle notifications being disabled outside the app
- Permission state should be re-checked on app resume

---

### 21.6 State & Flow

##### Permission Evaluation Flow

1. App initializes
2. Required permissions assumed available (network)
3. Optional permissions checked lazily
4. Feature modules enable/disable themselves based on permission state

##### Notification Permission Flow

- User enables a notification-related feature
- App requests permission
- OS returns grant or denial
- Feature state is persisted and respected

##### Location Permission Flow

- User enables location capture in settings or taps "Add Location" on a log entry
- App requests fine location permission
- OS returns grant or denial
- If granted, current coordinates are captured for the entry
- If denied, location fields remain null; user is informed once

---

### 21.7 Data Structures

##### Permission State (Logical Model)

| Field | Type | Description |
|-----|------|-------------|
| `permissionType` | enum | Network, Notifications, Location |
| `isGranted` | bool | Current OS-reported state |
| `lastCheckedAt` | datetime | Timestamp of last evaluation |

> Note: This may be transient state only and not persisted unless required by UI logic.

---

### 21.8 Failure Modes

#### 21.8.1 Permission Denied Behavior

##### Network Unavailable

- Sync operations fail gracefully
- Local logging remains fully functional
- Retry logic governed by sync subsystem

##### Notifications Denied

- Feature is disabled without error
- No blocking dialogs
- User may manually re-enable via OS settings

##### Location Denied

- Location fields remain null on log entries
- No blocking dialogs or repeated prompts
- User may manually enable via OS settings
- UI indicates location is unavailable
- Previously captured locations are unaffected

##### Permission Revoked While App Is Installed

- App detects change on resume
- Dependent features deactivate
- No crashes or undefined state

---

### 21.9 Assumptions & Open Questions

##### Assumptions

- Network access is always available at install time
- Core functionality does not require any dangerous permissions
- Notifications remain optional indefinitely

##### Open Questions

- Will background sync ever be introduced (may require additional OS constraints)?
- Should notification permission state be persisted for analytics or UX?
- Are platform-specific permission abstractions required in the domain layer?

---

### 21.10 Future Extensions

- Background tasks (may introduce battery or background execution constraints)
- Wearable or system integrations (likely new permission classes)
- Fine-grained notification channels or categories

---
