## 26. Documentation Conventions

### 26.1 Overview

This section defines how AshTrail documentation is written and maintained so that:

- Docs render consistently in Obsidian and in plain Markdown viewers.
- Diagrams are version-controlled and reviewable as text.
- Architectural decisions are captured in a consistent format.
- Documentation drift (“doc-rot”) is reduced via explicit update triggers.

### 26.2 Responsibilities

#### Authors (any contributor)
- Follow Markdown and diagram standards in this document.
- Update docs as part of the same change that modifies behavior, contracts, or architecture.
- Add an ADR when making a non-trivial, non-obvious decision that affects future work.

#### Reviewers
- Treat documentation updates as part of “definition of done” for behavior/architecture changes.
- Enforce heading structure, diagram conventions, and ADR completeness during review.

#### Maintainers
- Keep templates current (ADR template, diagram examples).
- Periodically prune/merge outdated docs (without deleting historical ADRs).

### 26.3 Data structures (fields, types, constraints)

#### 3.1 Markdown document structure

##### Required sections for each major documentation page (recommended standard):

- Title (H1)
- Sections using H2/H3/H4 as needed
- “Assumptions & Open Questions” when applicable
- “Last updated” metadata (optional but recommended)

##### Constraints

- Use a single H1 per file.
- Do not skip heading levels (H2 → H4 is invalid; must go H2 → H3 → H4).
- Avoid heading depth > H4 unless there is a strong reason (see open questions).

#### 3.2 Diagram blocks (Mermaid)

A diagram is stored as a fenced code block with language `mermaid`.

##### Constraints

- Diagram must be readable as plain text (no “diagram-only” meaning).
- Prefer stable node IDs (avoid auto-generated IDs that change on small edits).
- If the diagram encodes a flow/state machine, keep naming aligned with code identifiers.

##### Example

~~~mermaid
flowchart TD
  A[User action] --> B[State update]
  B --> C{Validation}
  C -- ok --> D[Persist]
  C -- error --> E[Show error]
~~~

#### 3.3 Decision records (ADR)

An ADR is a Markdown document containing a decision and its rationale.

##### Recommended file naming

- `YYYY-MM-DD-short-title.md`

##### Recommended directory

- `docs/adr/`

##### ADR fields (required)
- Title
- Status
- Context
- Decision
- Consequences

##### ADR fields (optional)

- Alternatives considered
- Links
- Follow-ups / TODOs

##### ADR template

	```markdown
	# ADR: <short title>
		
	- Date: YYYY-MM-DD
	- Status: Proposed | Accepted | Deprecated | Superseded
	- Authors: <names/handles>
	
	## Context
	- What problem are we solving?
	- What constraints exist (tech, product, time, security, etc.)?
	
	## Decision
	- What did we decide?
	- What is the scope of this decision?
	- What is explicitly out of scope?
	
	## Consequences
	### Positive
	- ...
	
	### Negative / Trade-offs
	- ...
	
	## Alternatives considered (optional)
	- Option A: ...
	- Option B: ...
	
	## Links (optional)
	- Related PRs/issues:
	- Related docs:
	- Supersedes / superseded by:
	```

### 26.4 State & flow (how data moves through the system)

### 26.1 Markdown Standards

#### 26.1.1 Heading Depth Rules
- H1: Document title only (one per file).
- H2: Major sections within the doc.
- H3: Subsections.
- H4: Sub-subsections (use sparingly).
- No skipping levels:
  - Valid: H2 → H3 → H4
  - Invalid: H2 → H4
- If a section gets too deep:
  - Split the document into multiple files, or
  - Flatten the structure by moving detail into bullet lists or tables.

##### Formatting rules

- Prefer bullet lists over long paragraphs.
- Prefer tables for stable “reference” information (enums, rules, mappings).
- Keep line lengths readable (soft wrap is fine; avoid walls of text).
- Use code formatting consistently:
  - Inline identifiers: `someIdentifier`
  - File paths: `docs/adr/...`
  - Code blocks for anything multi-line.

### 26.2 Diagrams

#### 26.2.1 Mermaid Usage

##### Use Mermaid for:

- Flow/state diagrams (user flows, state machines)
- Sequence diagrams (service interactions)
- ER-style sketches (only if they stay readable)

##### Do not use Mermaid for:

- Pixel-perfect UI mockups
- Diagrams that require heavy styling to be understandable

##### Diagram conventions

- Title diagrams via an immediately preceding heading (H3/H4), not by styling inside the diagram.
- Prefer left-to-right (`LR`) or top-down (`TD`) consistently within a doc.
- Keep diagrams small and composable:
  - If a diagram exceeds ~30 nodes/edges, split it.
- Use labels that match domain terms used in code and documentation.
- When representing a state machine, explicitly label events/triggers.

##### Sequence diagram example

~~~mermaid
sequenceDiagram
  participant UI as UI
  participant SM as State/Controller
  participant DB as Local DB

  UI->>SM: submitLogEntry(payload)
  SM->>SM: validate(payload)
  alt valid
    SM->>DB: insert(entry)
    DB-->>SM: ok
    SM-->>UI: success
  else invalid
    SM-->>UI: validationError
  end
~~~

### 26.3 Decision Records

#### 26.3.1 ADR Format

An ADR is required when a change introduces any of the following:
- A new architectural pattern or dependency that will shape future work.
- A change to persistence, sync, identity/account handling, or security boundaries.
- A trade-off decision that future contributors might otherwise reverse unknowingly.
- A “why” that cannot be inferred from code alone.

##### ADR lifecycle

- Proposed: written during exploration; may change.
- Accepted: decision is implemented (or implementation is actively underway).
- Deprecated: decision is no longer recommended, but may still exist in code.
- Superseded: replaced by a newer ADR (link both ways).

##### Linking
- Link the ADR from the PR/issue description.
- Link the PR/issue back from the ADR.

### 26.4 Keeping Docs in Sync

#### 26.4.1 Update Triggers
Update documentation in the same change when:
- Behavior changes:
  - User-visible flows
  - Validation rules
  - Any persistence/sync semantics
- Contracts change:
  - Public interfaces
  - Data models / schemas
  - File formats (import/export)
- Architecture changes:
  - State management boundaries
  - New services/components/modules
  - Cross-cutting concerns (logging, error handling, security)
- Decisions are made:
  - Add/modify ADRs for non-trivial decisions

**“Docs check” checklist (recommended in PRs)**
- [ ] Updated relevant docs for behavior/contract changes
- [ ] Added/updated Mermaid diagrams if flow/state changed
- [ ] Added ADR if decision is non-obvious and future-relevant
- [ ] Verified headings and code fences render correctly in Obsidian

### 26.5 Edge cases & failure modes

- **Heading drift / inconsistent structure**
  - Symptom: docs become hard to navigate or duplicate concepts.
  - Mitigation: enforce heading rules; split large docs.

- **Diagram rot**
  - Symptom: Mermaid diagram no longer matches actual flow.
  - Mitigation: require updates when flow changes; keep diagrams small.

- **ADR “status lies”**
  - Symptom: ADR marked Accepted but code never implemented (or reverted).
  - Mitigation: require status updates during follow-up PRs; use Superseded/Deprecated properly.

- **Copy-paste divergence**
  - Symptom: same rule described differently in multiple places.
  - Mitigation: single source of truth; link instead of duplicating.

- **Merge conflicts in docs**
  - Symptom: frequent conflicts in large monolithic docs.
  - Mitigation: split docs by domain; keep files smaller.

### 26.6 Future extensions (clearly labeled)

- Add a lightweight “docs lint” step:
  - Heading depth validation
  - Broken internal link detection
  - ADR template compliance checks (presence of required headings)

- Add a docs index:
  - `docs/README.md` that links to all major docs and ADRs

- Add standard front matter (if needed):
  - `Owner`, `Last updated`, `Applies to version/flavor`

---

### Assumptions & Open Questions

#### Assumptions
- Documentation lives in-repo (likely under `docs/`) and is intended to be pasted into (or mirrored in) Obsidian.
- Mermaid diagrams are acceptable as “diagrams-as-code” (text-first, VCS-friendly).

#### Open questions
- Where should ADRs live (confirm `docs/adr/` vs another location)?
- Do we want to enforce a maximum heading depth (H4) strictly, or allow deeper nesting in rare cases?
- Should “Docs check” be formalized as a PR template / checklist in the repo?
- Should diagrams be embedded inline only, or also allowed as separate `.mmd` files referenced by docs?

---
