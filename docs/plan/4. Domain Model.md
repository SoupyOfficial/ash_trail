## 4. Domain Model

### 4.1 Overview

The Domain Model defines the core entities and concepts that represent the problem space for AshTrail. These models form the foundation for all business logic, state management, and data persistence.

### 4.2 Core Concepts

#### 4.2.1 Account

##### Overview

Represents a single logical user context within AshTrail. All data (sessions, log entries, preferences) is scoped to an account.

##### Responsibilities

- Owns all sessions and log entries
- Defines isolation boundary between multiple users on the same device
- Acts as the root entity for sync and persistence

**Data Structures**

| Field          | Type     | Constraints                          |
| -------------- | -------- | ------------------------------------ |
| id             | String   | Required, locally unique             |
| remoteId       | String?  | Optional, assigned after remote sync |
| email          | String   | Required                             |
| displayName    | String   | Required                             |
| firstName      | String?  | Optional                             |
| lastName       | String?  | Optional                             |
| createdAt      | DateTime | Required, immutable                  |
| lastModifiedAt | DateTime | Required                             |

**State & Flow**

- Created locally
- May exist indefinitely without a remote ID
- Becomes sync-eligible once remote ID is assigned

**Edge Cases & Failure Modes**

- Account deletion must cascade to sessions and log entries
- Switching accounts must store still logged in data since swapping will not sign out the other user

**Future Extensions**

- Account-level preferences
- Account sharing or export/import

---

#### 4.2.2 Log Entry

**Overview**  
Atomic record representing a single logged event.

**Responsibilities**

- Capture user-entered or system-generated data
- Provide normalized, analyzable records

**Data Structures**

| Field          | Type     | Constraints |
| -------------- | -------- | ----------- |
| id             | String   | Required    |
| accountId      | String   | Required    |
| type           | Enum     | Required    |
| duration       | Number   | Required    |
| reason         | Enum     | Optional    |
| moodRating     | Number   | Optional    |
| physicalRating | Number   | Optional    |
| eventTime      | DateTime | Required    |
| createdAt      | DateTime | Required    |
| syncState      | Enum     | Required    |

**State & Flow**

- Created locally
- Stored offline-first
- Marked synced after successful remote persistence

**Edge Cases & Failure Modes**

- Duplicate entries due to retry logic
- Invalid values bypassing UI validation

**Future Extensions**

- Tagging
- Annotations or notes

---

#### 4.2.3 Log Entry Variants

#### 4.2.3.1 Manual Entry

**Overview**  
Represents a user-entered log with explicitly provided values.

**Responsibilities**

- Capture direct user input
- Preserve exact entered value

**Additional Constraints**

- value must be user-supplied
- eventTime may differ from createdAt

---

### 4.3 Identifiers

#### 4.3.1 Local IDs

**Overview**  
Identifiers generated locally for offline-first operation.

**Characteristics**

- Unique per device
- Stable across app restarts
- Used as primary keys locally

**Assumptions**

- Collision risk is negligible

---

#### 4.3.2 Remote IDs

**Overview**  
Identifiers assigned by the remote backend after sync.

**Characteristics**

- Optional until sync completes
- Mapped to local IDs
- Used for conflict resolution

**Edge Cases**

- Partial syncs where remote ID is missing

---

### 4.4 Time Semantics

#### 4.4.1 Event Time vs Sync Time

**Overview**  
Distinguishes when something happened from when it was synchronized.

**Definitions**

- **Event Time**: When the user action occurred
- **Sync Time**: When the record was persisted remotely

**Constraints**

- Event time is immutable
- Sync time may change across retries

**Assumptions**

- All times stored in UTC

---

### 4.5 Units & Normalization

#### 4.5.1 Measurement Units

**Overview**  
Defines the units used for log entry values and how they are normalized.

**Supported Units**

- Duration (seconds)
- Count-based units
- Other domain-specific units as defined in code

**Normalization Rules**

- Values stored in a canonical base unit
- Display units handled at presentation layer

**Open Questions**

- Are mixed units allowed per log type?
  - No

---

### 4.6 Constraints

#### 4.6.1 Required Fields

- accountId
- duration
- unit
- eventTime

Missing required fields must block persistence.

---

#### 4.6.2 Value Bounds

**Rules**

- Values must be non-negative
- Upper bounds enforced per log type

**Failure Modes**

- Invalid bounds causing rejected entries
- UI and domain validation divergence

**Future Extensions**

- Configurable bounds per account
