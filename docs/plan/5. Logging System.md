## 5. Logging System

### 5.1 Overview

#### 5.1.1 Why Logging Is Central

**Logging is the core function of AshTrail.**  
All analytics, insights, trends, and behavioral summaries are derived from log entries.

The system is designed to:

- Capture user activity with minimal friction
- Preserve data offline-first
- Support multi-account separation
- Enable deterministic replay and analysis over time

There is no “secondary” data source for behavior—**logs are the source of truth**.

---

### 5.2 Log Entry Lifecycle

This section describes how a log entry is created, stored, validated, and eventually synchronized.

#### 5.2.1 Creation

Log entries are created through manual user interaction:

- **Detailed Entry Form**: Full form with optional fields (mood, physical rating, reason, notes)
  - Duration recording via press-and-hold button (recommended pattern)
  - Or manual duration input
  - All rating and contextual fields are optional (null by default)
  - User can optionally add mood and physical ratings on a 1-10 scale

- **Backdated Entry**: Manual creation for past events (up to 30 days in the past)
  - Same form as detailed entry but with time picker override
  - Marked with lower time confidence
  - Useful for logging forgotten entries

Characteristics:

- Always tied to a visible user action
- Must pass full client-side validation
- Timestamp assigned at creation time via centralized time abstraction
- Associated with the currently active account and session context

---

#### 5.2.2 Local Persistence

All log entries are persisted locally immediately upon creation.

Local storage characteristics:

- Offline-first
- Durable across app restarts
- Account-scoped
- Append-only by default

Local persistence occurs:

- Before any remote sync attempt
- Regardless of network availability

##### Assumption

- Local persistence uses a structured, queryable store (not raw JSON blobs)

---

#### 5.2.3 Sync Eligibility

A log entry becomes eligible for sync when:

- It passes validation
- It is not marked as deleted
- It has not already been successfully synced
- A remote backend is configured and enabled

Sync metadata may include:

- Sync status:
  - `pending`: Entry created but not yet synced
  - `syncing`: Sync attempt in progress
  - `synced`: Successfully synced to remote backend
  - `error`: Sync failed, will retry with exponential backoff
  - `conflict`: Conflict detected (see Conflict Resolution section)
- Last sync attempt timestamp
- Remote identifier (if synced)

##### Conflict Handling

**Current Assumption**: Single-writer model
- One active writer per account at any time
- No concurrent edits across devices
- Conflicts are avoided by design, not resolved after the fact

**Future Enhancement**: Multi-device conflict resolution is planned but not implemented in MVP. See Conflict Resolution section in Data Persistence doc.

##### Sync Behavior

**Trigger Mode**: Automatic

- Sync attempts occur automatically when network is available
- User can also trigger manual sync via UI
- Sync runs in background; does not block UI

**Retry Strategy**:

- Failed syncs are retried with exponential backoff
- Initial retry: 30 seconds
- Max retry interval: 1 hour
- Failed entries remain marked as `pending` or `error`

**Eligibility Evaluation**:

- Evaluated lazily when sync service runs
- Not evaluated continuously per entry
- Batch processing of pending entries preferred over individual syncs

**Network Handling**:

- Sync pauses when network unavailable
- Resumes automatically when network restored
- No persistent background services; sync runs only when app active or in foreground-allowed background task

##### Assumption

- Network state detection is reliable
- Sync failures are transient and will eventually succeed

##### Open Questions

- Should sync retry limit be capped (max attempts before manual intervention)?
 	- Yes: Max 10 auto-retry attempts, then require manual retry
- Should users be notified of persistent sync failures?
 	- Yes: After 24 hours of failed sync attempts

---

#### 5.2.4 Remote Persistence

When eligible, logs may be written to a remote backend.

Remote persistence characteristics:

- Idempotent writes
- Account-isolated
- Conflict-safe (single-writer assumption)

Remote storage is treated as:

- A backup
- A cross-device sync layer
- A future analytics source

##### Assumption

- Remote persistence failures never block local usage

---

### 5.3 Input Types

AshTrail supports a constrained set of log input types to preserve consistency and enable analysis.

#### 5.3.1 Numeric Inputs

Examples:

- Counts
- Quantities
- Scalar measurements

Rules:

- Must be finite numbers
- No implicit unit conversion
- Stored as raw numeric values

Constraints:

- Upper and lower bounds may apply per field

---

#### 5.3.2 Duration Inputs

Examples:

- Time durations

Rules:

- Stored as normalized durations (not timestamps)
- Must be non-negative
- Precision defined centrally

**Assumption**

- Duration is stored independently of start/end timestamps

---

#### 5.3.3 Boolean Flags

Examples:

- Yes / No markers
- Binary conditions

Rules:

- Explicit true or false
- No tri-state values
- Defaults must be defined

---

#### 5.3.4 Reason (Enumerated)

Examples:

- Predefined reason codes
- Categorical metadata

Rules:

- Must be from a fixed, predefined set
- Optional field (may be null)
- Stored as enum value or string identifier

Constraints:

- Invalid enum values are rejected
- New reason types require schema update

**Assumption**

- Reason taxonomy is centrally defined
- No custom user-defined reasons in MVP

---

#### 5.3.5 Rating Inputs

Examples:

- Mood rating (subjective well-being)
- Physical rating (physical state)

Rules:

- Numeric values within a fixed range (1-10)
- Optional fields (default to null/"not set")
- Fractional values allowed (e.g., 5.5)

Constraints:

- Default state: null (user has not provided a rating)
- Valid range when provided: 1-10 (inclusive)
- Zero is explicitly NOT a valid rating value
- Both bounds are inclusive

Reset Behavior:

- User can reset a rating to null by not selecting/changing it
- Ratings persist until explicitly changed or form cleared
- Null ratings do not contribute to analytics calculations

**Assumption**

- Rating scale is consistent across all entries
- Scale semantics (low vs high) are documented elsewhere
- MVP does not track rating changes over time (only current value stored)

---

#### 5.3.6 Location Coordinates

Examples:

- GPS latitude/longitude pairs
- Geospatial context metadata

Rules:

- Optional field pair (both present or both null)
- Stored as decimal degrees (WGS84)
- Captured at log creation time, not event time

Constraints:

- Latitude: -90 to 90 (inclusive)
- Longitude: -180 to 180 (inclusive)
- No reverse geocoding or address resolution
- Requires explicit user permission

**Privacy**

- Location capture requires opt-in consent
- Can be disabled globally or per-entry
- Location data follows same sync/deletion rules as other fields

**Assumption**

- Raw coordinates are sufficient; no place names stored
- Location precision is device-dependent

---

### 5.4 Validation Rules

#### 5.4.1 Client-Side Validation

All validation occurs client-side before persistence.

Validation includes:

- Required field presence
- Type correctness
- Value bounds
- Logical consistency between fields

Failure behavior:

- Entry is rejected
- User is notified (UI-initiated only)
- No partial persistence

**Assumption**

- Server-side validation mirrors client rules but does not extend them

**Open Question**

- Are historical logs ever revalidated when rules change?
 	- No

---

#### 5.4.2 Field-Specific Validation Rules

##### Required Fields

- `accountId`: Must reference a valid local account
- `eventType`: Must be a recognized log type enum value
- `duration`: Must be non-negative, 0-3600 seconds (1 hour max)
- `unit`: Must be a recognized unit enum (e.g., seconds)
- `eventAt`: Must be valid datetime, not future-dated beyond 5 minute buffer
- `createdAt`: Must be valid datetime, ≥ app installation time
- `syncState`: Must be valid SyncState enum value
- `source`: Must be a recognized source enum (manual/imported/automation/migration)

##### Optional Fields with Constraints

- `reason`: If present, must be valid enum value (null is valid)
- `moodRating`: Null by default (not set). If provided, must be numeric 1-10 inclusive (zero is NOT allowed).
- `physicalRating`: Null by default (not set). If provided, must be numeric 1-10 inclusive (zero is NOT allowed).
- `latitude`: If present, must be -90 to 90; **requires `longitude` to also be present**
- `longitude`: If present, must be -180 to 180; **requires `latitude` to also be present**
- `note`: Optional text field (may be null or empty string)

##### Cross-Field Validation

- **Location pairing**: Both latitude and longitude must be present together, or both must be null. Invalid states (one present, one null) are rejected.
- **Event time**: Must not be significantly future-dated (max: current time + 5 minutes buffer)
- **Created timestamp**: Must be ≥ app installation time
- **Event type**: Must be a recognized enum value from EventType
- **Rating scale**: If ratings are present, they must be in 1-10 range (zero explicitly forbidden)

##### Value Bounds

- **Duration**: 0-3600 seconds (1 hour) per single entry
- **Ratings**: 1-10 inclusive when provided; zero is explicitly NOT valid; null/not-set is always valid
- **Coordinates**: Standard WGS84 decimal degree ranges (-90 to 90, -180 to 180)

##### Future-Dated Entries

- Future-dated entries are **not allowed** in MVP. All entries represent past or present events.
- Entries with eventAt > (now + 5 minutes) are rejected at validation time.

---

### 5.5 Editing & Deletion

Log entries are mutable only under strict rules.

#### 5.5.1 Soft vs Hard Deletes

**Soft Delete**

- Entry is marked as deleted
- Remains in local storage
- Excluded from analytics and sync
- Can be restored

**Hard Delete**

- Entry is permanently removed
- Irreversible
- Used sparingly (e.g., data repair)

**Assumption**

- UI exposes soft delete only
- Hard delete is reserved for internal tools or migrations

---

### 5.6 Assumptions

#### 5.6.1 Single-Writer Model

AshTrail assumes:

- One active writer per account at any time
- No concurrent edits across devices
- Conflicts are avoided by design, not resolved after the fact

This simplifies:

- Sync logic
- Conflict handling
- Data consistency guarantees

**Open Question**

- Will future versions support concurrent multi-device editing?
 	- No
