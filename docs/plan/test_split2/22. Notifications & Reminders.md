## 22. Notifications & Reminders

### 22.1 Overview

This module defines how AshTrail schedules and delivers reminders to prompt the user to create log entries.  
Its purpose is to reduce missed logs while preserving AshTrail’s offline-first and single-primary-user assumptions.

Notifications are **local-only** and do not rely on a backend service.

---

### 22.2 Responsibilities

The Notifications & Reminders system is responsible for:

- Scheduling reminder notifications on the local device
- Triggering notifications at user-configured times
- Ensuring reminders are aware of the currently active account
- Avoiding reminder delivery when notifications are disabled
- Re-registering reminders after app restarts or device reboot (where supported)

Out of scope:

- Cross-device notification synchronization
- Remote push notifications
- Behavioral or adaptive reminder logic (e.g., AI-based timing)

---

### 22.3 Data Structures

> **Note:** Exact persistence strategy must match existing configuration storage (e.g., Hive / local settings store).

#### 22.3.1 Reminder Configuration

| Field | Type | Constraints | Notes |
|---|---|---|---|
| `id` | string | unique | Local identifier for the reminder |
| `accountId` | string | required | Associated account |
| `enabled` | bool | required | Master toggle |
| `timeOfDay` | time | required | Local device time |
| `daysOfWeek` | enum[] | optional | If omitted, assumed daily |
| `createdAt` | datetime | required | For auditing/debug |
| `updatedAt` | datetime | required | For rescheduling logic |

Assumptions:
- All times are stored in **local device time**
- No timezone normalization is performed

---

### 22.4 State & Flow

#### 22.4.1 Scheduling Model

**Local Scheduling Only**

- Reminders are scheduled using platform-native local notification APIs
- Scheduling occurs when:
  - Reminder is created or updated
  - App starts
  - Active account changes
- Each reminder is registered independently

Flow:

1. User enables or updates a reminder
2. Reminder configuration is persisted locally
3. Platform scheduler registers a local notification
4. At trigger time, OS delivers the notification
5. App opens to logging screen when notification is tapped

No background execution is assumed beyond OS-level scheduling.

---

### 22.5 State Interaction

#### 22.5.1 Account Awareness

- Reminders are scoped to an `accountId`
- Only reminders belonging to the **active account** may be scheduled
- On account switch:
  - Existing scheduled reminders are canceled
  - Reminders for the new account are scheduled

Rationale:
- Prevents reminders firing for inactive or hidden accounts
- Aligns with AshTrail’s explicit account switching model

---

### 22.6 Edge Cases & Failure Modes

#### 22.6.1 Device Reboot

- Local notifications may be cleared on reboot (platform-dependent)
- On app launch:
  - All enabled reminders for the active account are re-registered
- If the app is never reopened:
  - Reminders may not fire (accepted limitation)

#### 22.6.2 Permissions Denied

- If notification permissions are denied:
  - Reminders remain configured but inactive
  - UI must reflect disabled delivery state
- No retry loop or nagging behavior is implemented

#### 22.6.3 Time Changes

- Manual device time changes may cause:
  - Missed notifications
  - Duplicate notifications
- No correction logic is implemented beyond next scheduled trigger

---

### 22.7 Future Extensions

> **Explicitly not implemented**

- Remote push notifications
- Smart reminders based on usage patterns
- Reminder analytics or completion tracking

---

### 22.8 Open Questions

#### 22.8.1 Cross-Device Sync

- Should reminders sync across devices for the same account?
- If yes:
  - What is the source of truth?
  - How are conflicts resolved?
- If no:
  - Should this be explicitly documented as a limitation?

#### 22.8.2 Multiple Reminders per Account

- Is more than one reminder per account allowed?
- If restricted:
  - Should enforcement be at UI or data layer?

#### 22.8.3 Missed Reminder Handling

- Should the app surface missed reminders when opened later?
- Or are missed notifications silently ignored?

These questions must be resolved before expanding reminder functionality.

---
