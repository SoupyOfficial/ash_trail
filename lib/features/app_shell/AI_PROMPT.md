# Feature Implementation Prompt: App Shell & Navigation Scaffold (ui.app_shell)

This prompt is auto-generated by dev_assistant `start-next-feature` to guide AI / developer implementation.
Do not remove architectural guardrails. Keep changes minimal, tested, and aligned with Clean Architecture.

## Context
Epic: ui
Priority: P0  Status: in_progress

## Rationale
Establish consistent structure for all screens and enable future features.

## Acceptance Criteria
- Implements app root with Riverpod providers initialization and error boundary.
- iPhone (incl. 16 Pro Max) uses bottom navigation bar with at least Home and Logs tabs (initial release scope); Charts & Settings accessible via overflow / future tabs.
- Side / rail navigation activates for width ≥ 840dp (tablet/desktop) showing Home, Logs, Charts, Settings icons.
- Navigation state (active tab + stack) persists across app restarts (last active primary tab preserved).
- Deep links to primary tabs supported (home, logs) and future-ready for charts, settings.
- Tab bar safe-area aware; no overlap with iOS home indicator; minimum tap target ≥48px.
- Logs tab initially contains both log table and inline / toggleable chart view (chart segment behind feature flag until charts epic delivered).
- Separate Charts tab disabled until insights.charts_time_series marked done; enabling it moves chart UI from Logs tab.
- All interactive surfaces respect iOS safe areas including Dynamic Island / notch; no clipped snackbars, sheets, or toasts.
- One-hand ergonomics validated: primary record action within comfortable thumb zone on iPhone 16 Pro Max portrait.
- iOS back-swipe gesture (edge pan) works on nested stacks without visual jank.
- Baseline haptic events are invoked (delegated to ui.haptics_baseline for mapping).

## Components / Modules
- app_shell
- nav_bar
- adaptive_layout

## Screens
- home
- logs
- charts
- settings

## Offline
- behavior: shell_renders_with_cached_theme_and_last_tab

## Output Contract (Reminders)
The PR for this feature should include in order:
1. Plan (goal, assumptions, acceptance)
2. Files changed list (paths + purpose)
3. Code (full files, no TODO placeholders)
4. Tests (unit/widget/integration as applicable)
5. Docs diffs / ADR additions (if architectural decisions changed)
6. Manual QA steps (including offline & error paths)
7. Performance & Accessibility checks
8. Conventional commit message (subject <=72 chars)

## Finalization Workflow
Before requesting a PR: repeatedly run the dry-run finalize until all validations pass.
Command: python scripts/dev_assistant.py finalize-feature --feature-id {feature_id} --dry-run --json
Check JSON: validations.tests_ok, validations.coverage_ok (>= ${MIN_PROJECT_COV}% line), validations.todos_ok all true.
If any false: add/adjust tests, raise coverage, or complete checklist (AI_PROMPT). Re-run dry-run.
Only when all pass: run without --dry-run to auto-stage + commit (optionally add --push).
Never commit partial feature via finalize-feature; use normal git commits for intermediate work.

## Implementation Guidance
1. Maintain feature-first folder structure (domain, data, presentation).
2. Expose public API via Riverpod providers; avoid direct Firestore/Dio in widgets.
3. Add Freezed entities & DTO mappers; ensure serialization isolated.
4. Implement use cases (pure) in domain layer returning Either<AppFailure, T>.
5. Add minimal tests: mapper, use case happy path + one failure, provider logic.
6. Respect performance & accessibility notes above.
7. Update feature status to in_progress only if delivering code (already auto-set).
8. Keep AI generated explanations concise in PR body; no large boilerplate.

## Initial TODO Checklist
- [x] Define domain entities / value objects (if new). (AppTab enum)
- [x] Add use cases (list in code comment). (GetLastActiveTabUseCase, SetLastActiveTabUseCase)
- [x] Create repository interface + impl placeholders. (AppShellRepository + SharedPreferences impl + in-memory)
- [x] Wire Riverpod providers (autoDispose where suitable). (activeTabProvider + use case providers)
- [x] Implement presentation widgets/screens behind feature flag if needed. (Adaptive AppShell with disabled Charts tab)
- [x] Write unit tests (≥85% for new lines). (Controller, widget, deep link, repository persistence tests added.)
- [x] Update docs / ADR if architectural decisions differ. (ADR-0003 documents enum decision)

## Do Not
- Introduce new heavy dependencies without ADR.
- Bypass error handling (always map to AppFailure).
- Expose raw exceptions or Firestore documents to UI.

(End of prompt)
