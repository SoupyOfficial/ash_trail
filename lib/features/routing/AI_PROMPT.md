# Feature Implementation Prompt: Typed Routing & Deep Link Handling (ui.routing)

This prompt is auto-generated by dev_assistant `start-next-feature` to guide AI / developer implementation.
Do not remove architectural guardrails. Keep changes minimal, tested, and aligned with Clean Architecture.

## Context
Epic: ui
Priority: P0  Status: in_progress

## Rationale
(None provided)

## Acceptance Criteria
- Define central route map with typed params (e.g., log detail id).
- Unknown routes redirect to safe default (home) with telemetry event.
- Supports push and replace for modal vs full-screen flows.
- Handles incoming deep link for /log/{id} opening detail view when available locally or after fetch.
- Supports Universal Links / custom scheme (ashtrail://) for primary routes and log detail.
- State restoration: deep link launched cold start restores target screen after providers initialize.

## Components / Modules
- router

## Telemetry Events
- route_navigate
- route_unknown

## Implementation Guidance
1. Maintain feature-first folder structure (domain, data, presentation).
2. Expose public API via Riverpod providers; avoid direct Firestore/Dio in widgets.
3. Add Freezed entities & DTO mappers; ensure serialization isolated.
4. Implement use cases (pure) in domain layer returning Either<AppFailure, T>.
5. Add minimal tests: mapper, use case happy path + one failure, provider logic.
6. Respect performance & accessibility notes above.
7. Update feature status to in_progress only if delivering code (already auto-set).
8. Keep AI generated explanations concise in PR body; no large boilerplate.

## Initial TODO Checklist
- [x] Define domain entities / value objects (if new). (RouteIntent classes)
- [x] Add use cases (list in code comment). (ResolveDeepLinkUseCase created)
- [x] Create repository interface + impl placeholders. (TelemetryService abstraction added; log repository not required yet)
- [x] Wire Riverpod providers (autoDispose where suitable). (routerProvider, deepLinkInitialLocationProvider)
- [x] Implement presentation widgets/screens behind feature flag if needed. (HomeScreen, LogDetailScreen baseline)
- [x] Write unit tests (â‰¥85% for new lines). (Deep link resolver tests added; further coverage incoming)
- [x] Update docs / ADR if architectural decisions differ. (ADR-0003 added)

## Do Not
- Introduce new heavy dependencies without ADR.
- Bypass error handling (always map to AppFailure).
- Expose raw exceptions or Firestore documents to UI.

(End of prompt)

## Output Contract (Reminders)
1. Plan
2. Files to Change
3. Code (full files)
4. Tests
5. Docs / ADR
6. Manual QA
7. Performance & A11y
8. Commit Message
## Finalization Workflow
Run dry-run finalize until all checks pass:
`python scripts/dev_assistant.py finalize-feature --feature-id ui.routing --dry-run --json`
Ensure tests_ok, coverage_ok, todos_ok == true. If not, add tests / docs, mark checklist, rerun. Then run without --dry-run to commit (optionally --push).
