#!/bin/bash
# Pre-push hook for Flutter project
# Matches TestFlight CI workflow: pub get -> test -> pods -> build iOS

set -e  # Exit on any error

echo "ğŸš€ Running pre-push checks..."

# Check if we're pushing to main or mvp branches (critical branches that need iOS validation)
current_branch=$(git rev-parse --abbrev-ref HEAD)
if [[ "$current_branch" == "main" || "$current_branch" == "mvp" ]]; then
    echo "ğŸ“± Verifying iOS build for TestFlight deployment..."
    
    # Step 1: Install dependencies (matches CI)
    echo "ğŸ“¦ Running flutter pub get..."
    flutter pub get
    
    # Step 2: Run tests (matches CI)
    echo "ğŸ§ª Running flutter test..."
    if ! flutter test; then
        echo "âŒ Tests failed. Fix tests before pushing to main."
        exit 1
    fi
    
    # Step 3: Install CocoaPods dependencies (matches CI)
    echo "ğŸ Installing CocoaPods dependencies..."
    cd ios
    if ! pod install --repo-update; then
        echo "âŒ CocoaPods installation failed."
        cd ..
        exit 1
    fi
    cd ..
    
    # Step 4: Build iOS without code signing (matches CI build step)
    # This catches deployment target issues and compile errors
    echo "ğŸ”¨ Building iOS release (no code signing)..."
    if ! flutter build ios --release --no-codesign; then
        echo "âŒ iOS build failed. This would fail in TestFlight CI/CD."
        echo "Common issues:"
        echo "  - Check ios/Podfile for deployment target configuration"
        echo "  - Run 'cd ios && pod install' to update pods"
        echo "  - Verify all pods support iOS 13.0+"
        exit 1
    fi
    
    echo "âœ… iOS build successful! Ready for TestFlight deployment."
fi

echo "âœ… All pre-push checks passed!"
exit 0
